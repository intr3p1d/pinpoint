<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.navercorp.pinpoint.exceptiontrace.web.dao.PinotExceptionTraceDao">

    <resultMap id="errorSummaryEntity" type="ErrorSummaryEntity">
    </resultMap>

    <select id="selectErrorSummaries" resultMap="errorSummaryEntity"
            parameterType="ExceptionTraceQueryParameter">
        SELECT
        arraySliceInt(
        HISTOGRAM("timestamp", #{range.from}, #{range.to}, #{timeWindowRangeCount}), 0, #{timeWindowRangeCount}
        ) as "values",
        count(*) as "count",
        <include refid="getGroupedFieldNameEntity"></include>
        LASTWITHTIME(arrayElementAtString(stackTraceClassName, 1), "timestamp",
        'STRING') as firstLineOfClassName,
        LASTWITHTIME(arrayElementAtString(stackTraceMethodName, 1), "timestamp",
        'STRING') as firstLineOfMethodName,

        LASTWITHTIME("timestamp", "timestamp", 'STRING') as lastTimestamp,

        applicationName,

        LASTWITHTIME(agentId, "timestamp", 'STRING') as "agentId",
        LASTWITHTIME(transactionId, "timestamp", 'STRING') as "transactionId",
        LASTWITHTIME(spanId, "timestamp", 'LONG') as "spanId",
        LASTWITHTIME(exceptionId, "timestamp", 'LONG') as "exceptionId"

        FROM
        <include refid="exceptionTraceTable"></include>

        WHERE
        applicationName = #{applicationName}
        <if test="agentId != null">
            AND agentId = #{agentId}
        </if>
        AND "timestamp" BETWEEN #{range.from} AND #{range.to}
        GROUP BY applicationName
        <include refid="groupByAllAttributes"></include>
        ORDER BY count(*) DESC LIMIT 100
    </select>
</mapper>